---
title: "Appendix (Extra analyses)"
author: "Connor Quiroz"
date: "2025-02-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# General data cleaning + visualization + analysis packages
library(tidyverse)
library(ggformula)
library(countrycode)
library(data.table)
library(arrow)
library(cowplot)
library(RColorBrewer)

# Map creation
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)

# Load in packages needed for ARTIS
library(devtools)
library(tidytext)
# devtools::install_github("davidsjoberg/ggsankey")
library(ggsankey)
# devtools::install_github("Seafood-Globalization-Lab/exploreARTIS@v1.0.0", dependencies = TRUE)
library(exploreARTIS)

# For Packages for fishbase
# remotes::install_github("cboettig/duckdbfs", force = TRUE)
# remotes::install_github("ropensci/rfishbase")
library(duckdbfs)
library(rfishbase)
```

```{r load in functions}
taxa_level_vars <- function(data, taxa_var = "sciname",ungroup = FALSE) {
  if (ungroup == FALSE) {
    data %>%
      mutate(
        taxa_level = case_when(
          !!sym(taxa_var) == kingdom ~ "kingdom",
          !!sym(taxa_var) == phylum ~ "phylum",
          !!sym(taxa_var) == superclass ~ "superclass",
          !!sym(taxa_var) == class ~ "class",
          !!sym(taxa_var) == order ~ "order",
          !!sym(taxa_var) == family ~ "family",
          !!sym(taxa_var) == subfamily ~ "subfamily",
          !!sym(taxa_var) == genus ~ "genus",
          str_detect(!!sym(taxa_var), pattern = "\ ") ~ "species"
        )
      )
  }
  
  else {
    data %>%
      ungroup() %>%
      distinct(sciname) %>%
      left_join(sciname, by = "sciname") %>%
      mutate(
        taxa_level = case_when(
          !!sym(taxa_var) == kingdom ~ "kingdom",
          !!sym(taxa_var) == phylum ~ "phylum",
          !!sym(taxa_var) == superclass ~ "superclass",
          !!sym(taxa_var) == class ~ "class",
          !!sym(taxa_var) == order ~ "order",
          !!sym(taxa_var) == family ~ "family",
          !!sym(taxa_var) == subfamily ~ "subfamily",
          !!sym(taxa_var) == genus ~ "genus",
          str_detect(!!sym(taxa_var), pattern = "\ ") ~ "species"
        )
      )
  }
  
  
}

# fishbase::country()

# Another way to get species distributions in certain countries (need to see how many countries are represented in this vs FAO, which doesn't directly report countries, but needs to be joined on eez data).
taxa_presence_or_absence <- function(data = "fishbase", obtain_stats = FALSE) {
  
  # Determine which dataset to use
  if (data == "fishbase") {
    artis_fishbase_locations <- fb_presences_country
  } else if (data == "sealifebase") {
    artis_fishbase_locations <- slb_presences_country
  } else {
    stop("Data parameter must be 'fishbase' or 'sealifebase'")
  }
  
  if (obtain_stats == TRUE) {
    # Calculate statistics
    valid_locations <- artis_fishbase_locations %>%
      filter(Status %in% c("native", "Native", "introduced", "endemic", "Endemic") & 
             !is.na(country)) %>%
      mutate(eez_name = case_when(
        country == "Micronesia" ~ "FSM",
        TRUE ~ countrycode(country, 
                           origin = 'country.name',
                           destination = 'iso3c', 
                           warn = FALSE))) %>%
      filter(!is.na(eez_name))
    
    num_countries <- valid_locations %>%
      distinct(eez_name) %>%
      nrow()
    
    print(paste0("Number of countries joined to ", data, ": ", num_countries))
    
    # Data coverage calculations
    if (exists("scinames_excluding_tradeflows")) {
      num_species_artis <- scinames_excluding_tradeflows %>%
        filter(str_count(sciname_joinable_to_fishbase, "\\S+") >= 2) %>%
        distinct(sciname_joinable_to_fishbase) %>%
        nrow()
      
      num_species_fishbase <- valid_locations %>%
        distinct(ScientificName) %>%
        nrow()
      
      species_coverage_pct <- round((num_species_fishbase / num_species_artis) * 100, 2)
      
      print(paste0("Number of species in ", data, ": ", num_species_fishbase))
      print(paste0("Number of species in ARTIS: ", num_species_artis))
      print(paste0("Percent of ARTIS species that ", data, " has: ", species_coverage_pct, "%"))
    }
    
  } else {
    # Create presence/absence data
    
    # FIXED: Simplified country presence logic
    fishbase_country_presences <- artis_fishbase_locations %>%
      filter(Status %in% c("native", "Native", "introduced", "endemic", "Endemic")) %>%
      mutate(eez_name = case_when( # Correct micronesia since countrycode won't
        country == "Micronesia" ~ "FSM",
        TRUE ~ countrycode(country, 
                           origin = 'country.name',
                           destination = 'iso3c', 
                           warn = FALSE))) %>%
      filter(!is.na(eez_name)) %>%
      group_by(ScientificName) %>%
      summarize(
        countries_found = paste(unique(eez_name), collapse = " "),
        .groups = 'drop'
      ) %>%
      rename(sciname_joinable_to_fishbase = ScientificName) %>%
      mutate(source = data) %>% 
  left_join(unaligned_names[,c("fb_slb_scientific_name", "new_sciname")], by = c("sciname_joinable_to_fishbase" = "fb_slb_scientific_name")) %>% # Reassign some fb/slb names to match the updated names that ARTIS uses
  mutate(sciname_joinable_to_fishbase = case_when(!is.na(new_sciname) ~ new_sciname, 
                                    TRUE ~ sciname_joinable_to_fishbase))
    
    # Join with consumption data
    if (exists("scinames_excluding_tradeflows")) {
      consumption_countries_joined <- scinames_excluding_tradeflows %>%
        left_join(fishbase_country_presences, by = "sciname_joinable_to_fishbase")
      
      # FIXED: Proper presence/absence determination
      consumption_countries_joined <- consumption_countries_joined %>%
        mutate(
          presence_or_absence = case_when(
            is.na(countries_found) ~ NA_real_,
            str_detect(countries_found, paste0("\\b", eez_iso3c, "\\b")) ~ 1,
            TRUE ~ 0
          )
        ) %>% mutate(
        joined = case_when(!is.na(eez_iso3c) & !is.na(countries_found) ~ "both",
                           !is.na(eez_iso3c) ~ "only in artis",
                           TRUE ~ paste0("only in ", data)),
        source = case_when(joined == "both" ~ data,
                           joined == paste0("only in ", data) ~ data,
                           TRUE ~ NA))
      
      return(consumption_countries_joined)
    } else {
      warning("scinames_excluding_tradeflows not found")
      return(fishbase_country_presences)
    }
  }
}

create_hierarchical_presence <- function(country_data) {
  
  # Get all taxa that are definitely present (presence_or_absence == 1)
  present_taxa <- country_data %>%
    filter(presence_or_absence == 1) %>%
    select(sciname_hs_modified, species, genus, subfamily, family, order, class, superclass, phylum, kingdom) %>%
    distinct()
  
  # Create vectors of present taxa at each level (remove NAs)
  present_species <- present_taxa$species[!is.na(present_taxa$species)]
  present_genera <- present_taxa$genus[!is.na(present_taxa$genus)]
  present_subfamilies <- present_taxa$subfamily[!is.na(present_taxa$subfamily)]
  present_families <- present_taxa$family[!is.na(present_taxa$family)]
  present_orders <- present_taxa$order[!is.na(present_taxa$order)]
  present_classes <- present_taxa$class[!is.na(present_taxa$class)]
  present_superclasses <- present_taxa$superclass[!is.na(present_taxa$superclass)]
  present_phyla <- present_taxa$phylum[!is.na(present_taxa$phylum)]
  present_kingdoms <- present_taxa$kingdom[!is.na(present_taxa$kingdom)]
  
  # Now determine presence for all taxa in the country
  country_data %>%
    mutate(
      presence_or_absence_all_taxa = case_when(
        # If directly present in fishbase/sealifebase
        presence_or_absence == 1 ~ 1,
        
        # If species not in fishbase/sealifebase, mark as NA
        sciname_hs_modified %in% fbslb_species_not_in_artis ~ NA_real_,
        
        # Check hierarchical presence (fixed syntax)
        (!is.na(species) & species %in% present_species) ~ 1,
        (!is.na(genus) & genus %in% present_genera) ~ 1,
        (!is.na(subfamily) & subfamily %in% present_subfamilies) ~ 1,
        (!is.na(family) & family %in% present_families) ~ 1,
        (!is.na(order) & order %in% present_orders) ~ 1,
        (!is.na(class) & class %in% present_classes) ~ 1,
        (!is.na(superclass) & superclass %in% present_superclasses) ~ 1,
        (!is.na(phylum) & phylum %in% present_phyla) ~ 1,
        (!is.na(kingdom) & kingdom %in% present_kingdoms) ~ 1,
        
        # Otherwise absent
        TRUE ~ 0
      )
    ) %>%
    # Automatically assign any artis species that isn't in fb/slb as absent
    mutate(presence_or_absence_all_taxa = case_when(
      !is.na(species) & is.na(source) ~ 0,
      TRUE ~ presence_or_absence_all_taxa
    ))
}
```

```{r consuption data reading}
# Read in consumption data
consumption_all_years <- read_parquet("../data/consumption/example_consumption_eez_2024_12_06.parquet")

# Filter working data to just 2019
consumption <- consumption_all_years %>%
  filter(year == 2019)

# Read in taxonomic data
sciname <- fread("../data/consumption/sciname.csv")

# Get unique taxa names by eez (excluding trade flows)
scinames_excluding_tradeflows <- consumption_all_years %>%
  ungroup() %>%
  distinct(eez_iso3c, sciname_hs_modified) %>%
  left_join(sciname, by = c("sciname_hs_modified" = "sciname")) %>%
  rename(sciname = "sciname_hs_modified") %>%
  taxa_level_vars() %>%
  rename(sciname_hs_modified = "sciname") %>%
  filter(!is.na(sciname_hs_modified)) %>%
  ungroup()

# Write to parquet
write_parquet(scinames_excluding_tradeflows, "../output/scinames_excluding_tradeflows.parquet")
```

```{r get fb/slb data}
if (!file.exists("../data/fb_slb_data/")) {
  
  # Create new directory for FB/SLB data
  dir.create("../data/fb_slb_data")
  
  # Obtain FB / SLB country() data
  fb_presences_country <- country(server = "fishbase")
  slb_presences_country <- country(server = "sealifebase")
  
  fb_species_codes <- load_taxa(server = "fishbase") %>%
    rename(ScientificName = "Species") %>%
    mutate(Species = sapply(str_split(ScientificName, " "), `[`, 2)) %>%
    relocate(Species, .before = Genus)

  slb_species_codes <- load_taxa(server = "sealifebase") %>%
    rename(ScientificName = "Species") %>%
    mutate(Species = sapply(str_split(ScientificName, " "), `[`, 2)) %>%
    relocate(Species, .before = Genus)
  
  # Join FB / SLB country() to species codes
  fb_presences_country <- fb_presences_country %>%
    left_join(fb_species_codes, by = "SpecCode") %>%
    rename(SubFamily = "Subfamily") %>%
    mutate(Phylum = NA_character_, Kingdom = NA_character_) %>% # Create new 
    relocate(c(ScientificName, Species, Genus, SubFamily, Family, Order, Class, SuperClass, Phylum, Kingdom), .after = SpecCode) %>% # Move scinames to the front of dataset
    mutate(across(c(ScientificName, Species, Genus, SubFamily, Family, Order, Class, SuperClass, Phylum, Kingdom), ~ str_to_lower(.))) # convert scinames to lowercase
  
  # Same thing but for sealifebase
  slb_presences_country <- slb_presences_country %>%
    left_join(slb_species_codes, by = "SpecCode") %>%
    rename(SubFamily = "Subfamily") %>%
    mutate(SuperClass = NA_character_) %>%
    relocate(c(ScientificName, Species, Genus, SubFamily, Family, Order, Class, SuperClass, Phylum, Kingdom), .after = SpecCode) %>%
    mutate(across(c(ScientificName, Species, Genus, SubFamily, Family, Order, Class, SuperClass, Phylum, Kingdom), ~ str_to_lower(.))) 
  
  # Write files to .parquet
  write_parquet(fb_presences_country, "../data/fb_slb_data/fb_presences_country.parquet")
  write_parquet(slb_presences_country, "../data/fb_slb_data/slb_presences_country.parquet")
  write_parquet(slb_species_codes, "../data/fb_slb_data/fb_species_codes.parquet")
  write_parquet(slb_species_codes, "../data/fb_slb_data/slb_species_codes.parquet")
}
```

```{r add in fishbase / sealifebase data connections}
# Read in consumption data
scinames_excluding_tradeflows <- read_parquet("../output/scinames_excluding_tradeflows.parquet")

# Read in fishbase/sealifebase data
fb_presences_country <- read_parquet("../data/fb_slb_data/fb_presences_country.parquet")
slb_presences_country <- read_parquet("../data/fb_slb_data/slb_presences_country.parquet")

fb_species_codes <- read_parquet("../data/fb_slb_data/fb_species_codes.parquet")
slb_species_codes <- read_parquet("../data/fb_slb_data/slb_species_codes.parquet")

# Read in unaligned species names
unaligned_names <- fread("../data/fb_slb_data/unaligned_names.csv")

# Look at which artis species names differ from fb/slb species names (ARTIS is more up to date)
fb_slb <- bind_rows(fb_presences_country, slb_presences_country)
setdiff(sciname$sciname[str_detect(sciname$sciname, " ")],fb_slb$ScientificName)

scinames_excluding_tradeflows <- scinames_excluding_tradeflows %>%
  mutate(sciname_joinable_to_fishbase = sciname_hs_modified)

# ***
# MAKING SURE ARTIS SCINAMES ALIGN WITH FISHBASE

# # of ARTIS unique scientific names (includes higher taxonomic levels that aren't only species) - 1771 total scientific names
length(unique(scinames_excluding_tradeflows$sciname_joinable_to_fishbase))

# # of ARTIS species (1421 species)
scinames_excluding_tradeflows %>%
  ungroup() %>%
  filter(str_detect(sciname_hs_modified, " ")) %>%
  distinct(sciname_hs_modified) %>%
  nrow()

# METHOD 2: rfishbase::country()

# Obtain stats on fishbase/sealifebase data
taxa_presence_or_absence(data = "fishbase", obtain_stats = TRUE)
taxa_presence_or_absence(data = "sealifebase", obtain_stats = TRUE)

# Create presence/absence data
fishbase_presences_country <- taxa_presence_or_absence(data = "fishbase")
sealifebase_presences_country <- taxa_presence_or_absence(data = "sealifebase")

# Number of rows in ARTIS data (fishbase + sealifebase presence data)
nrow(fishbase_presences_country)
nrow(sealifebase_presences_country)

# Combine fishbase/sealifebase data
merged_presence_absence_data_country <- bind_rows(fishbase_presences_country[-which(sealifebase_presences_country$source == "sealifebase"),], sealifebase_presences_country %>% filter(source == "sealifebase"))

# Add true species column
merged_presence_absence_data_country <- merged_presence_absence_data_country %>%
  mutate(species = case_when(str_detect(sciname_hs_modified, " ") ~ sapply(str_split(sciname_hs_modified, " "), `[`, 2),
                             TRUE ~ NA))

# Determine if lower resolution taxa are in an eez (e.g., if a species for a given country is found there that is also a lower resolution taxa like actinoptergyii, then all actinoptergyii or higher will be found in that country) -

# Create a dataset to identify whether a species comes from ARTIS or slb/fb
# List of ARTIS species that aren't matched to either fishbase or sealifebase - this is what can be derived from this code
species_determination <- full_join(
  bind_rows(fb_presences_country %>% 
              mutate(source = "fishbase"), 
            slb_presences_country %>% 
              mutate(source = "sealifebase")) %>%
    mutate(ScientificName = tolower(ScientificName)) %>%
    select(ScientificName) %>%
    distinct() %>% 
    mutate(fb_slb = 1), 
  sciname %>% 
    select(sciname, common_name) %>%
    filter(str_detect(sciname, " ")) %>% 
    distinct() %>% 
    mutate(artis = 1), 
  by = c("ScientificName" = "sciname")) 

# Species in ARTIS but not in FB/SLB
artis_species_not_in_fbslb <- species_determination %>%
  filter(is.na(fb_slb) == TRUE, artis == 1) %>%
  pull(ScientificName)

# Species in FB/SLB but not ARTIS
fbslb_species_not_in_artis <- species_determination %>%
  filter(fb_slb == 1, is.na(artis) == TRUE) %>%
  pull(ScientificName)

# Create 
pa_only_artis <- merged_presence_absence_data_country %>%
  mutate(presence_or_absence = case_when(
    sciname_joinable_to_fishbase %in% fbslb_species_not_in_artis ~ NA, 
    TRUE ~ presence_or_absence))

# Get presences and absences for taxa levels higher than true species
presence_absence_data <- pa_only_artis %>%
  group_by(eez_iso3c) %>%
  group_modify(~create_hierarchical_presence(.x)) %>%
  relocate(presence_or_absence_all_taxa, .after = presence_or_absence) %>%
  ungroup() %>%
  select(eez_iso3c, sciname_hs_modified, presence_or_absence_all_taxa)



# Remove extraneous objects to save memory to make the following left_join faster
rm(consumption, fb_presences_country, fb_slb, fb_species_codes, fishbase_presences_country,
   merged_presence_absence_data_country, pa_only_artis, sciname, sciname_metadata,
   scinames_excluding_tradeflows, sealifebase_presences_country, slb_presences_country, 
   slb_species_codes, species_determination, unaligned_names, artis_species_not_in_fbslb,
   fbslb_species_not_in_artis)

# Garbage collection
gc()

# Join to consumption data
consumption_presence_absence <- left_join(consumption_all_years, presence_absence_data, by = c("sciname_hs_modified", "eez_iso3c")) %>%
  relocate(eez_iso3c, .after = "consumer_iso3c")

# Write to .parquet
write_parquet(presence_absence_data, "../output/presence_absence_data.parquet")

# Write to .parquet
write_parquet(consumption_presence_absence, "../output/consumption_presence_absence.parquet")

# Remove more objects
rm(consumption_all_years, presence_absence_data)

# Garbage collection
gc()
```
